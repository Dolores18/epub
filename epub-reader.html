<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

    <!-- ç¦ç”¨ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- PWA ç›¸å…³æ ‡ç­¾ -->
    <meta name="description" content="ä¸€ä¸ªç°ä»£åŒ–çš„EPUBç”µå­ä¹¦é˜…è¯»å™¨ï¼Œæ”¯æŒæ—¥è¯­è¯å…¸æŸ¥è¯¢åŠŸèƒ½">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/assets/icons/icon-152x152.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/icon-16x16.png">

    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/epub-reader.css?v=" id="mainCSS">

    <!-- å¼•å…¥JavaScriptåº“ -->
    <script src="assets/js/jszip.min.js?v=" id="jszipJS"></script>
    <script src="assets/js/epub-fixed.js?v=" id="epubJS"></script>

    <!-- å¼•å…¥è¯å…¸åŠŸèƒ½ -->
    <script src="assets/js/dictionary.js?v=" id="dictJS"></script>
</head>

<body>
    <!-- é˜…è¯»å™¨ä¸»ä½“å®¹å™¨ -->
    <div class="reader-container" id="readerContainer">
        <!-- ä¾§è¾¹æ ï¼šä¹¦æœ¬ä¿¡æ¯ + ç›®å½• -->
        <div class="sidebar" id="sidebar" class="hidden">
            <div class="sidebar-header">
                <button class="close-sidebar-btn" id="closeSidebarBtn">Ã—</button>
            </div>

            <!-- ä¹¦æœ¬ä¿¡æ¯åŒºåŸŸ -->
            <div class="book-info">
                <h2 class="book-title">ãƒãƒ«ã‚¦ã‚§ãƒ¼ã®æ£®</h2>
                <p class="book-subtitle">(æŒªå¨çš„æ£®æ—)</p>
                <p class="book-author">ä½œè€…: æ‘ä¸Šæ˜¥æ¨¹</p>

                <!-- æ–‡ä»¶å¯¼å…¥ -->
                <div class="file-import">
                    <input type="file" id="importEpub" accept=".epub" />
                    <label for="importEpub" class="import-btn">ğŸ“ é€‰æ‹©EPUBæ–‡ä»¶</label>
                </div>
            </div>

            <!-- ç›®å½•åŒºåŸŸ -->
            <div class="toc-section">
                <h3>ç›®å½•</h3>
                <div id="toc" class="toc-list"></div>
            </div>
        </div>

        <!-- é˜…è¯»å™¨è§†å›¾ -->
        <div id="viewer" class="viewer">
            <div class="loading" id="loading">
                <p>æ­£åœ¨åŠ è½½ç”µå­ä¹¦...</p>
            </div>

            <!-- å·¦å³ç¿»é¡µæ§ä»¶ -->
            <div class="page-controls">
                <button class="page-control prev-page" id="prevPageBtn" title="ä¸Šä¸€é¡µ">
                    <span class="chevron-left">â€¹</span>
                </button>
                <button class="page-control next-page" id="nextPageBtn" title="ä¸‹ä¸€é¡µ">
                    <span class="chevron-right">â€º</span>
                </button>
            </div>
            <!-- èœå•å”¤å‡ºæŒ‰é’®ï¼ˆå³ä¸‹è§’åœ†å½¢æŒ‰é’®ï¼‰ -->
            <div class="menu-trigger" id="menuTrigger">
                <span>â˜°</span>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶èœå•æ ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div class="bottom-menu" id="bottomMenu">
        <div class="menu-section">
            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-section">
                <div class="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <span id="progressText">0%</span>
            </div>

            <!-- åŠŸèƒ½æ§åˆ¶ -->
            <div class="function-controls">
                <button onclick="toggleSidebar()" title="ç›®å½•">ğŸ“š</button>
                <button id="dictToggleBtn" onclick="Dictionary.toggle()" title="è¯å…¸åŠŸèƒ½">
                    <svg class="dict-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 4h2v5l-1-.75L9 9V4zm9 16H6V4h1v9l3-2.25L13 13V4h5v16z"/>
                        <path d="M8 15h8v1H8zm0-2h8v1H8zm0-2h5v1H8z"/>
                    </svg>
                </button>
                <button onclick="changeFontSize(-1)" title="å­—ä½“ç¼©å°">A-</button>
                <button onclick="changeFontSize(1)" title="å­—ä½“æ”¾å¤§">A+</button>
                <button onclick="toggleSettings()" title="è®¾ç½®">âš™ï¸</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <div class="settings-header">
                <h3>é˜…è¯»è®¾ç½®</h3>
                <button class="close-settings-btn" onclick="toggleSettings()">Ã—</button>
            </div>

            <div class="settings-body">
                <div class="setting-item">
                    <label for="fontSelect">å­—ä½“é€‰æ‹©ï¼š</label>
                    <select id="fontSelect">
                        <option value="auto" selected>ğŸ¤– è‡ªåŠ¨æ£€æµ‹ï¼ˆæ ¹æ®è¯­è¨€ï¼‰</option>
                        <option
                            value="IPAexMinchoWeb, IPAexMincho, 'Hiragino Mincho ProN', 'Yu Mincho', 'MS Mincho', serif">
                            ğŸ‡¯ğŸ‡µ ç½‘é¡µIPAæ˜æœä½“ï¼ˆå†…åµŒï¼‰</option>
                        <option value="IPAexMincho, 'Hiragino Mincho ProN', 'Yu Mincho', 'MS Mincho', serif">ğŸ‡¯ğŸ‡µ IPAæ˜æœä½“ï¼ˆç³»ç»Ÿï¼‰
                        </option>
                        <option value="IPAexGothic, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'MS Gothic', sans-serif">
                            ğŸ‡¯ğŸ‡µ IPAå“¥ç‰¹ä½“</option>
                        <option value="'Hiragino Mincho ProN', 'Yu Mincho', 'MS Mincho', serif">ğŸ‡¯ğŸ‡µ ç³»ç»Ÿæ˜æœä½“</option>
                        <option value="'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'MS Gothic', sans-serif">ğŸ‡¯ğŸ‡µ ç³»ç»Ÿå“¥ç‰¹ä½“</option>
                        <option value="SimSun, 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', sans-serif">ğŸ‡¨ğŸ‡³ ä¸­æ–‡å­—ä½“</option>
                        <option value="Batang, 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif">ğŸ‡°ğŸ‡· éŸ©æ–‡å­—ä½“</option>
                        <option value="">ğŸŒ ç³»ç»Ÿé»˜è®¤å­—ä½“</option>
                    </select>
                </div>



                <div class="setting-item">
                    <label for="topMargin">ä¸Šè¾¹è·ï¼š</label>
                    <input type="range" id="topMargin" min="0" max="100" value="20" step="5">
                    <span id="topMarginValue">20px</span>
                </div>

                <div class="setting-item">
                    <label for="bottomMargin">ä¸‹è¾¹è·ï¼š</label>
                    <input type="range" id="bottomMargin" min="0" max="100" value="30" step="5">
                    <span id="bottomMarginValue">30px</span>
                </div>

                <div class="setting-item">
                    <label for="leftMargin">å·¦è¾¹è·ï¼š</label>
                    <input type="range" id="leftMargin" min="0" max="100" value="30" step="5">
                    <span id="leftMarginValue">30px</span>
                </div>

                <div class="setting-item">
                    <label for="rightMargin">å³è¾¹è·ï¼š</label>
                    <input type="range" id="rightMargin" min="0" max="100" value="30" step="5">
                    <span id="rightMarginValue">30px</span>
                </div>

                <div class="setting-item">
                    <label for="lineHeight">è¡Œé«˜ï¼š</label>
                    <input type="range" id="lineHeight" min="1.2" max="2.5" value="1.8" step="0.1">
                    <span id="lineHeightValue">1.8</span>
                </div>

                <div class="setting-item">
                    <button onclick="resetMargins()" class="reset-btn">é‡ç½®é¡µè¾¹è·</button>
                    <button onclick="saveMarginSettings()" class="save-btn">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ä¸»è¦ä¸šåŠ¡é€»è¾‘ -->
    <script src="assets/js/epub-reader.js?v=" id="mainJS"></script>

    <!-- ç¼“å­˜ç ´åè„šæœ¬ -->
    <script>
        // åŠ¨æ€è®¾ç½®ç‰ˆæœ¬å·æ¥ç ´åç¼“å­˜
        const version = Date.now();
        const links = [
            { id: 'mainCSS', attr: 'href' },
            { id: 'jszipJS', attr: 'src' },
            { id: 'epubJS', attr: 'src' },
            { id: 'dictJS', attr: 'src' },
            { id: 'mainJS', attr: 'src' }
        ];

        links.forEach(link => {
            const element = document.getElementById(link.id);
            if (element) {
                const url = element.getAttribute(link.attr);
                element.setAttribute(link.attr, url + version);
            }
        });

        console.log('ğŸ”„ ç¼“å­˜ç ´åå®Œæˆï¼Œç‰ˆæœ¬å·:', version);
    </script>

    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);

                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

        // å¤„ç†å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // æ˜¾ç¤ºå®‰è£…æç¤º
            const installButton = document.createElement('button');
            installButton.textContent = 'å®‰è£…åº”ç”¨';
            installButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                z-index: 10000;
                font-size: 14px;
            `;

            installButton.addEventListener('click', () => {
                installButton.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—å®‰è£…');
                    } else {
                        console.log('ç”¨æˆ·æ‹’ç»å®‰è£…');
                    }
                    deferredPrompt = null;
                });
            });

            document.body.appendChild(installButton);
        });
    </script>
</body>

</html>