<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

    <!-- 禁用缓存 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- PWA 相关标签 -->
    <meta name="description" content="一个现代化的EPUB电子书阅读器，支持日语词典查询功能">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/assets/icons/icon-152x152.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/icon-16x16.png">

    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="assets/css/epub-reader.css?v=" id="mainCSS">

    <!-- 引入JavaScript库 -->
    <script src="assets/js/jszip.min.js?v=" id="jszipJS"></script>
    <script src="assets/js/epub-fixed.js?v=" id="epubJS"></script>

    <!-- 引入词典功能 -->
    <script src="assets/js/dictionary.js?v=" id="dictJS"></script>
</head>

<body>
    <!-- 阅读器主体容器 -->
    <div class="reader-container" id="readerContainer">
        <!-- 侧边栏：书本信息 + 目录 -->
        <div class="sidebar" id="sidebar" class="hidden">
            <div class="sidebar-header">
                <button class="close-sidebar-btn" id="closeSidebarBtn">×</button>
            </div>

            <!-- 书本信息区域 -->
            <div class="book-info">
                <h2 class="book-title">ノルウェーの森</h2>
                <p class="book-subtitle">(挪威的森林)</p>
                <p class="book-author">作者: 村上春樹</p>

                <!-- 文件导入 -->
                <div class="file-import">
                    <input type="file" id="importEpub" accept=".epub" />
                    <label for="importEpub" class="import-btn">📁 选择EPUB文件</label>
                </div>
            </div>

            <!-- 目录区域 -->
            <div class="toc-section">
                <h3>目录</h3>
                <div id="toc" class="toc-list"></div>
            </div>
        </div>

        <!-- 阅读器视图 -->
        <div id="viewer" class="viewer">
            <div class="loading" id="loading">
                <p>正在加载电子书...</p>
            </div>

            <!-- 左右翻页控件 -->
            <div class="page-controls">
                <button class="page-control prev-page" id="prevPageBtn" title="上一页">
                    <span class="chevron-left">‹</span>
                </button>
                <button class="page-control next-page" id="nextPageBtn" title="下一页">
                    <span class="chevron-right">›</span>
                </button>
            </div>
            <!-- 菜单唤出按钮（右下角圆形按钮） -->
            <div class="menu-trigger" id="menuTrigger">
                <span>☰</span>
            </div>
        </div>
    </div>

    <!-- 底部控制菜单栏（默认隐藏） -->
    <div class="bottom-menu" id="bottomMenu">
        <div class="menu-section">
            <!-- 进度显示 -->
            <div class="progress-section">
                <div class="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <span id="progressText">0%</span>
            </div>

            <!-- 功能控制 -->
            <div class="function-controls">
                <button onclick="toggleSidebar()" title="目录">📚</button>
                <button id="dictToggleBtn" onclick="Dictionary.toggle()" title="词典功能">
                    <svg class="dict-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 4h2v5l-1-.75L9 9V4zm9 16H6V4h1v9l3-2.25L13 13V4h5v16z"/>
                        <path d="M8 15h8v1H8zm0-2h8v1H8zm0-2h5v1H8z"/>
                    </svg>
                </button>
                <button onclick="changeFontSize(-1)" title="字体缩小">A-</button>
                <button onclick="changeFontSize(1)" title="字体放大">A+</button>
                <button onclick="toggleSettings()" title="设置">⚙️</button>
            </div>
        </div>
    </div>

    <!-- 设置面板（默认隐藏） -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <div class="settings-header">
                <h3>阅读设置</h3>
                <button class="close-settings-btn" onclick="toggleSettings()">×</button>
            </div>

            <div class="settings-body">
                <div class="setting-item">
                    <label for="fontSelect">字体选择：</label>
                    <select id="fontSelect">
                        <option value="auto" selected>🤖 自动检测（根据语言）</option>
                        <option
                            value="IPAexMinchoWeb, IPAexMincho, 'Hiragino Mincho ProN', 'Yu Mincho', 'MS Mincho', serif">
                            🇯🇵 网页IPA明朝体（内嵌）</option>
                        <option value="IPAexMincho, 'Hiragino Mincho ProN', 'Yu Mincho', 'MS Mincho', serif">🇯🇵 IPA明朝体（系统）
                        </option>
                        <option value="IPAexGothic, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'MS Gothic', sans-serif">
                            🇯🇵 IPA哥特体</option>
                        <option value="'Hiragino Mincho ProN', 'Yu Mincho', 'MS Mincho', serif">🇯🇵 系统明朝体</option>
                        <option value="'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'MS Gothic', sans-serif">🇯🇵 系统哥特体</option>
                        <option value="SimSun, 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', sans-serif">🇨🇳 中文字体</option>
                        <option value="Batang, 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif">🇰🇷 韩文字体</option>
                        <option value="">🌍 系统默认字体</option>
                    </select>
                </div>



                <div class="setting-item">
                    <label for="topMargin">上边距：</label>
                    <input type="range" id="topMargin" min="0" max="100" value="20" step="5">
                    <span id="topMarginValue">20px</span>
                </div>

                <div class="setting-item">
                    <label for="bottomMargin">下边距：</label>
                    <input type="range" id="bottomMargin" min="0" max="100" value="30" step="5">
                    <span id="bottomMarginValue">30px</span>
                </div>

                <div class="setting-item">
                    <label for="leftMargin">左边距：</label>
                    <input type="range" id="leftMargin" min="0" max="100" value="30" step="5">
                    <span id="leftMarginValue">30px</span>
                </div>

                <div class="setting-item">
                    <label for="rightMargin">右边距：</label>
                    <input type="range" id="rightMargin" min="0" max="100" value="30" step="5">
                    <span id="rightMarginValue">30px</span>
                </div>

                <div class="setting-item">
                    <label for="lineHeight">行高：</label>
                    <input type="range" id="lineHeight" min="1.2" max="2.5" value="1.8" step="0.1">
                    <span id="lineHeightValue">1.8</span>
                </div>

                <div class="setting-item">
                    <button onclick="resetMargins()" class="reset-btn">重置页边距</button>
                    <button onclick="saveMarginSettings()" class="save-btn">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入主要业务逻辑 -->
    <script src="assets/js/epub-reader.js?v=" id="mainJS"></script>

    <!-- 缓存破坏脚本 -->
    <script>
        // 动态设置版本号来破坏缓存
        const version = Date.now();
        const links = [
            { id: 'mainCSS', attr: 'href' },
            { id: 'jszipJS', attr: 'src' },
            { id: 'epubJS', attr: 'src' },
            { id: 'dictJS', attr: 'src' },
            { id: 'mainJS', attr: 'src' }
        ];

        links.forEach(link => {
            const element = document.getElementById(link.id);
            if (element) {
                const url = element.getAttribute(link.attr);
                element.setAttribute(link.attr, url + version);
            }
        });

        console.log('🔄 缓存破坏完成，版本号:', version);
    </script>

    <!-- PWA Service Worker 注册 -->
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker 注册成功:', registration.scope);

                        // 检查更新
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 有新版本可用
                                    if (confirm('发现新版本，是否立即更新？')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker 注册失败:', error);
                    });
            });
        }

        // 处理安装提示
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // 显示安装提示
            const installButton = document.createElement('button');
            installButton.textContent = '安装应用';
            installButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                z-index: 10000;
                font-size: 14px;
            `;

            installButton.addEventListener('click', () => {
                installButton.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('用户接受安装');
                    } else {
                        console.log('用户拒绝安装');
                    }
                    deferredPrompt = null;
                });
            });

            document.body.appendChild(installButton);
        });
    </script>
</body>

</html>